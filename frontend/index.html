<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="style.css">
    
    <script src="config.js"></script>
    <script src="https://st.max.ru/js/max-web-app.js"></script>

    <script>

        (function() {
            function loadYandexMaps() {
                const apiKey = window.AppConfig?.YANDEX_MAPS_API_KEY || 'YOUR_YANDEX_MAPS_API_KEY';
                
                console.log('Loading Yandex Maps with API key:', apiKey ? apiKey.substring(0, 10) + '...' : 'not set');
                
                if (apiKey === 'YOUR_YANDEX_MAPS_API_KEY') {
                    console.warn('Yandex Maps API key not set. Please set YANDEX_MAPS_API_KEY in config.js');
                }
                
                if (document.querySelector('script[src*="api-maps.yandex.ru"]')) {
                    console.log('Yandex Maps script already loaded');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://api-maps.yandex.ru/2.1/?apikey=${apiKey}&lang=ru_RU&load=package.full`;
                script.type = 'text/javascript';
                script.async = true;
                
                script.onload = function() {
                    console.log('Yandex Maps script loaded successfully');
                };
                
                script.onerror = function() {
                    console.error('Failed to load Yandex Maps script');
                    const mapContainer = document.getElementById('map');
                    if (mapContainer) {
                        mapContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Не удалось загрузить карту. Проверьте подключение к интернету и настройки API ключа.</div>';
                    }
                };
                
                document.head.appendChild(script);
                console.log('Yandex Maps script tag added to head');
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(loadYandexMaps, 50);
                });
            } else {
                setTimeout(loadYandexMaps, 50);
            }
        })();
    </script>
<script src="./icons.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="top-search">
            <div class="search-row">
                <input id="searchInput" type="search" placeholder="Введите город, район" />
                <button id="searchBtn" class="icon-btn" aria-label="search" data-icon="search"></button>
            </div>
            <div class="filters-row">
                <button class="filter-btn" id="filterBtn">
                    <span data-icon="filter" class="filter-icon"></span>
                    <span>Фильтры</span>
                </button>
                <div class="view-toggle">
                    <span>Карта</span>
                    <label class="toggle">
                        <input type="checkbox" id="toggleView" />
                        <span class="toggle-track"></span>
                    </label>
                    <span>Список</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div id="mapView" class="content-view active">
                <div id="map" class="map-canvas"></div>
            </div>
            <div id="listView" class="content-view">
                <div class="list-scroll">
                    <div class="events-list" id="regularEvents">
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <div class="nav-inner">
                <button class="nav-item" data-screen="game" aria-label="game">
                    <span data-icon="tree" class="nav-icon"></span>
                </button>
                <button class="nav-item active" data-screen="map" aria-label="map">
                    <span data-icon="map" class="nav-icon"></span>
                </button>
                <button class="nav-item" data-screen="rating" aria-label="rating">
                    <span data-icon="rating" class="nav-icon"></span>
                </button>
                <button class="nav-item" data-screen="profile" aria-label="profile">
                    <span data-icon="profile" class="nav-icon"></span>
                </button>
            </div>
        </nav>
    </div>

    <script src="icons.js"></script>
    <script src="bridge.js"></script>
    <script>
        function initMapManager() {
            if (typeof ymaps !== 'undefined') {
                const script = document.createElement('script');
                script.src = 'map.js';
                script.onload = function() {
                    const appScript = document.createElement('script');
                    appScript.src = 'app.js';
                    document.body.appendChild(appScript);
                };
                document.body.appendChild(script);
            } else {
                setTimeout(initMapManager, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initMapManager, 200); 
            });
        } else {
            setTimeout(initMapManager, 200);
        }
    </script>
    <script>
        window.dobroBot = null;
        document.addEventListener('DOMContentLoaded', () => {
            if (window.IconManager) window.IconManager.replaceIcons();
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const screen = e.currentTarget.dataset.screen;
                    if (screen === 'game') window.location.href = 'game.html';
                    else if (screen === 'profile') window.location.href = 'profile.html';
                    else if (screen === 'rating') window.location.href = 'rating.html';
                });
            });
        });
    </script>
</body>
</html>